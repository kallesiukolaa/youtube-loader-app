name: Docker Image CI

on:
    push:
        branches: ["main"]

jobs:
    builds:
        runs-on: ubuntu-latest
        permissions: 
          contents: read
          packages: write

        steps:
            - name: Get Image Tag
              id: image-tag
              run: echo "::set-output name=image-tag-name::website-image-name-$(date +%s)"

            - uses: actions/checkout@v4
            - name: Build the Docker image
              env:
                IMAGE_TAG_NAME: ${{ steps.image-tag.outputs.image-tag-name }}
              run: docker build --build-arg EFS_PATH_BUILD=/my-videos . -t $IMAGE_TAG_NAME

            - name: Github registry login
              uses: docker/login-action@v3
              with:
                registry: https://ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}

            - name: Push docker image to github
              env:
                IMAGE_TAG_NAME: ${{ steps.image-tag.outputs.image-tag-name }}
                username: ${{ github.actor }}
              run: docker tag $IMAGE_TAG_NAME ghcr.io/$username/youtube_loader:latest && docker push ghcr.io/$username/youtube_loader:latest
              